<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8">
    <title>Play Game</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link rel="stylesheet" th:href="@{/css/card.css}">
    <link rel="stylesheet" th:href="@{/css/fragments.css}">
    <link rel="stylesheet" th:href="@{/css/playgame.css}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <link rel="icon" type="image/png" sizes="16x16" href="/images/SA-Flare.png">
</head>
<body>
    <!--Inserts header.html as a fragment-->
    <div th:insert="~{fragments/header :: header}"></div>

    <!--Displays GAME OVER and game winner-->
    <div class="game-result-container" th:if="${gameOver}" style="text-align: center; margin-top: 10px;">
        <h1>Game Over!</h1>
        <p th:if="${player1Score > cpuScore}"><strong>Congratulations!</strong><br>You have won the game.</p>
        <p th:if="${player1Score < cpuScore}"><strong>Player 2 has won the game.</strong><br>Better luck next time!</p>
        <p th:if="${player1Score == cpuScore}"><strong>It's a draw!</strong><br>Good effort!</p>
    </div>

    <!--Displays round winner-->
    <div th:if="${#lists.size(playerHand) > 0 and !gameOver}" class="round-result-container" style="text-align: center; margin-top: 10px;">
        <h2 th:if="${statValue > cpuStatValue and roundComplete == true}">Player 1 Wins!</h2>
        <h2 th:if="${statValue < cpuStatValue and roundComplete == true}">Player 2 Wins!</h2>
        <h2 th:if="${statValue == cpuStatValue and roundComplete == true}">It's a Draw!</h2>
    </div>

    <!-- Score Display -->
    <div style="display: flex; justify-content: space-between; padding: 10px;">
        <div style="text-align: left;">
            <h2>Player 1:</h2>
            <h2><strong th:text="${player1Score}"></strong>/<strong th:text="${pointsToWin}"></strong></h2>
        </div>
        <div style="text-align: right;">
            <h2>Player 2:</h2>
            <h2><strong th:text="${cpuScore}"></strong>/<strong th:text="${pointsToWin}"></strong></h2>
        </div>
    </div>

    <!-- Displays who is attacking that round -->
    <div class="round-result-container" style="text-align: center; margin-top: 10px;">
        <h2 th:if="${currentAttacker == 'P1' and roundComplete == false}"><strong>You</strong> are attacking!</h2>
        <h2 th:if="${currentAttacker == 'P2' and roundComplete == false}"><strong>Player 2</strong> is attacking!</h2>
    </div>

    <!--    Displays the round's chosen cards from both players-->
    <div class="game-round-display">
    <!--    Displays P1's chosen card-->
        <div class="final-card-container" th:if="${playedCard != null}">
            <h2>Your Card</h2>
            <div class="card-wrap"
                 th:classappend="${playedCard.deck.name == 'The Simpsons' ? ' simpson' :
                             playedCard.deck.name == 'Harry Potter' ? ' hp' :
                             playedCard.deck.name == 'Marvel' ? ' marvel' :
                             playedCard.deck.name == 'Disney' ? ' disney' :
                             playedCard.deck.name == 'Pop-culture' ? ' pop-culture' :
                             playedCard.deck.name == 'Brit-tv' ? ' brit-tv' :
                             playedCard.deck.name == 'Kids-tv' ? ' kids-tv' : ''}">
                <strong class="card-name" th:text="${#strings.toUpperCase(playedCard.name)}"></strong>
                <div class="card-image-box">
                    <img th:src="${playedCard.imageSource}" alt="Card image" width="220"/>
                </div>
                <div class="card-text-box card-box-style">
                    <span th:text="${playedCard.flavourText}"></span>
                </div>
                <div class="stat-row">
<!--                    Clickable strength stat-->
                    <form th:action="@{'/game/play/p1-attack-2'}" method="post" style="display: inline;">
                        <input type="hidden" name="cardId" th:value="${playedCard.name}" />
                        <input type="hidden" name="chosenStat" value="strength" />
                        <button type="submit" class="stat-text-box card-box-style"
                                th:classappend="${playedCard.strength >= 90 ? ' card-box-rare' : ''}">
                            <span>Strength: <strong th:text="${playedCard.strength}"></strong></span>
                        </button>
                    </form>
<!--                    Clickable wisdom stat-->
                    <form th:action="@{'/game/play/p1-attack-2'}" method="post" style="display: inline;">
                        <input type="hidden" name="cardId" th:value="${playedCard.id}" />
                        <input type="hidden" name="chosenStat" value="wisdom" />
                        <button type="submit" class="stat-text-box card-box-style"
                                th:classappend="${playedCard.strength >= 90 ? ' card-box-rare' : ''}">
                            <span>Wisdom: <strong th:text="${playedCard.wisdom}"></strong></span>
                        </button>
                    </form>
                </div>
                <div class="stat-row">
<!--                    Clickable defence stat-->
                    <form th:action="@{'/game/play/p1-attack-2'}" method="post" style="display: inline;">
                        <input type="hidden" name="cardId" th:value="${playedCard.id}" />
                        <input type="hidden" name="chosenStat" value="defence" />
                        <button type="submit" class="stat-text-box card-box-style"
                                th:classappend="${playedCard.defence >= 90 ? ' card-box-rare' : ''}">
                            <span>Defence: <strong th:text="${playedCard.defence}"></strong></span>
                        </button>
                    </form>
<!--                    Clickable luck stat-->
                    <form th:action="@{'/game/play/p1-attack-2'}" method="post" style="display: inline;">
                        <input type="hidden" name="cardId" th:value="${playedCard.id}" />
                        <input type="hidden" name="chosenStat" value="luck" />
                        <button type="submit" class="stat-text-box card-box-style"
                                th:classappend="${playedCard.luck >= 90 ? ' card-box-rare' : ''}">
                            <span>Luck: <strong th:text="${playedCard.luck}"></strong></span>
                        </button>
                    </form>
                </div>
                <!-- Clickable custom stat -->
                <div class="unique-stat-box text-nowrap" >
                <form th:action="@{'/game/play/p1-attack-2'}" method="post" style="display: inline;">
                    <input type="hidden" name="cardId" th:value="${playedCard.id}" />
                    <input type="hidden" name="chosenStat" th:value="${playedCard.deck.uniqueStatName}" />
                    <button type="submit" class="stat-text-box card-box-style text-nowrap"
                            th:classappend="${playedCard.customStat >= 90 ? ' card-box-rare' : ''}">
                        <span>
                            <span th:text="${playedCard.deck.uniqueStatName}"></span>:
                            <strong th:text="${playedCard.customStat}"></strong>
                        </span>
                    </button>
                </form>
                </div>
            </div>
        </div>
        <div th:unless="${playedCard != null}" class="card-placeholder">
            <span>No card chosen yet</span>
        </div>

<!--        Display VS image-->
        <div class="vs-image-container">
            <img src="/gameplay/vs.png" alt="VS" class="vs-image">
        </div>

<!--        Display CPU's card-->
        <div class="final-card-container" th:if="${playedCard != null and chosenStat != null}">
            <h2>Player 2's Card</h2>
            <div class="card-wrap"
                 th:classappend="${cpuPlayedCard.deck.name == 'The Simpsons' ? ' simpson' :
                             cpuPlayedCard.deck.name == 'Harry Potter' ? ' hp' :
                             cpuPlayedCard.deck.name == 'Marvel' ? ' marvel' :
                             cpuPlayedCard.deck.name == 'Disney' ? ' disney' :
                             cpuPlayedCard.deck.name == 'Pop-culture' ? ' pop-culture' :
                             cpuPlayedCard.deck.name == 'Brit-tv' ? ' brit-tv' :
                             cpuPlayedCard.deck.name == 'Kids-tv' ? ' kids-tv' : ''}">
                <strong class="card-name" th:text="${#strings.toUpperCase(cpuPlayedCard.name)}"></strong>
                <div class="card-image-box">
                    <img th:src="${cpuPlayedCard.imageSource}" alt="Card image" width="220"/>
                </div>
                <div class="card-text-box card-box-style">
                    <span th:text="${cpuPlayedCard.flavourText}"></span>
                </div>
                <div class="stat-row">
                    <div class="stat-text-box card-box-style" th:classappend="${cpuPlayedCard.strength >= 90 ? ' card-box-rare' : ''}">
                        <span>Strength: <strong th:text="${cpuPlayedCard.strength}"></strong></span>
                    </div>
                    <div class="stat-text-box card-box-style" th:classappend="${cpuPlayedCard.wisdom >= 90 ? ' card-box-rare' : ''}">
                        <span>Wisdom: <strong th:text="${cpuPlayedCard.wisdom}"></strong></span>
                    </div>
                </div>
                <div class="stat-row">
                    <div class="stat-text-box card-box-style" th:classappend="${cpuPlayedCard.defence >= 90 ? ' card-box-rare' : ''}">
                        <span>Defence: <strong th:text="${cpuPlayedCard.defence}"></strong></span>
                    </div>
                    <div class="stat-text-box card-box-style" th:classappend="${cpuPlayedCard.luck >= 90 ? ' card-box-rare' : ''}">
                        <span>Luck: <strong th:text="${cpuPlayedCard.luck}"></strong></span>
                    </div>
                </div>
                <div class="unique-stat-box card-box-style text-nowrap" th:classappend="${cpuPlayedCard.customStat >= 90 ? ' card-box-rare' : ''}">
                <span>
                    <span th:text="' ' + ${cpuPlayedCard.deck.uniqueStatName} + ': '"></span>
                    <strong th:text="${cpuPlayedCard.customStat}"></strong>
                </span>
                </div>
            </div>
        </div>
        <div th:unless="${cpuPlayedCard != null and chosenStat != null}" class="card-placeholder">
            <span>No card chosen yet</span>
        </div>
    </div>

<!--    &lt;!&ndash; Display messages from the controller &ndash;&gt;-->
<!--    <div th:if="${successMessage}" class="message success">-->
<!--        <p th:text="${successMessage}"></p>-->
<!--    </div>-->

    <div th:if="${cpuPlayedCard != null and roundComplete}" style="display: flex; justify-content: space-between; margin-top: 3px;">
    <!-- Show results after battle -->
    <div th:if="${cpuPlayedCard != null}" style="text-align: left; margin-top: 3px;">
        <h2>Your Reveal</h2>
        <p>You played: <strong th:text="${playedCard.name}"></strong></p>
        <p th:if="${chosenStat != 'customStat'}">You picked: <strong th:text="${chosenStat}"></strong></p>
        <p th:if="${chosenStat == 'customStat'}">You picked: <strong th:text="${customStatName}"></strong></p>
        <p>Stat value: <strong th:text="${statValue}"></strong></p>
    </div>

    <!--Reveals CPU's stats after the round's completed-->
    <div th:if="${cpuPlayedCard != null}" style="float: right; text-align: right;">
        <h2>Player 2's Reveal</h2>
        <p>Played: <strong th:text="${cpuPlayedCard.name}"></strong></p>
        <p th:if="${cpuChosenStat != 'customStat'}">Stat: <strong th:text="${cpuChosenStat}"></strong></p>
        <p th:if="${cpuChosenStat == 'customStat'}">Stat: <strong th:text="${cpuCustomStatName}"></strong></p>
        <p>Stat value: <strong th:text="${cpuStatValue}"></strong></p>
    </div>
    </div>


    <!--Shows the CPU's selected stat, IF they go first in that round.-->
    <div class="cpu-stat-container" style="width: 300px; margin: 0 auto; text-align: center;" th:if="${cpuStat != null && playerStat == null}">
        <h2>Battle Stat: </h2>
    <!--    <h2><strong th:text="${cpuStat}"></strong></h2>-->
        <h2 th:if="${cpuStat != 'customStat'}"><strong th:text="${cpuStat}"></strong></h2>
        <h2 th:if="${cpuStat == 'customStat'}"><strong th:text="${cpuCustomStatName}"></strong></h2>
    </div>


    <!-- Next round: if CPU's turn to attack -->
    <div style="width: 300px; margin: 0 auto; text-align: center; margin-top: 10px;"
         th:if="${roundComplete == true and p1IsAttackingNextRound == false and !gameOver}">
        <form th:action="@{/game/play/p2-attack}" method="get">
            <button type="submit" class="button">Next Round</button>
        </form>

    </div>

    <!-- Next round: if P1's turn to attack -->
    <div style="width: 300px; margin: 0 auto; text-align: center; margin-top: 10px;"
         th:if="${roundComplete == true and p1IsAttackingNextRound == true and !gameOver}">
        <form th:action="@{/game/play}" method="get">
            <button type="submit" class="button">Next Round</button>
        </form>
    </div>

    <!--Displays player's hand, prompts player to pick card-->
    <div class="hand-container" th:if="${playerHand != null and !gameOver}">
        <h2>Your Hand:</h2>
        <!-- Clickable, player can choose a card -->
        <div th:if="${roundComplete == false and playedCard == null}">
            <div class="card-row" style="display: flex; flex-wrap: wrap; gap: 16px;">
                <div th:each="card : ${playerHand}" class="p-3">
                    <form th:action="@{${cpuStat == null ? '/game/play/p1-attack-1' : '/game/play/p1-defend'}}" method="post">
                        <input type="hidden" name="cardId" th:value="${card.id}" />
                        <div class="card-wrap" style="cursor: pointer;"
                             onclick="this.closest('form').submit();"
                             th:classappend="${card.deck.name == 'The Simpsons' ? ' simpson' :
                                         card.deck.name == 'Harry Potter' ? ' hp' :
                                         card.deck.name == 'Marvel' ? ' marvel' :
                                         card.deck.name == 'Disney' ? ' disney' :
                                         card.deck.name == 'Pop-culture' ? ' pop-culture' :
                                         card.deck.name == 'Brit-tv' ? ' brit-tv' :
                                         card.deck.name == 'Kids-tv' ? ' kids-tv' : ''}">
                            <strong class="card-name" th:text="${#strings.toUpperCase(card.name)}"></strong>
                            <div class="card-image-box">
                                <img th:src="${card.imageSource}" alt="Card image" width="220"/>
                            </div>
                            <div class="card-text-box card-box-style">
                                <span th:text="${card.flavourText}"></span>
                            </div>
                            <div class="stat-row">
                                <div class="stat-text-box card-box-style" th:classappend="${card.strength >= 90 ? ' card-box-rare' : ''}">
                                    <span>Strength: <strong th:text="${card.strength}"></strong></span>
                                </div>
                                <div class="stat-text-box card-box-style" th:classappend="${card.wisdom >= 90 ? ' card-box-rare' : ''}">
                                    <span>Wisdom: <strong th:text="${card.wisdom}"></strong></span>
                                </div>
                            </div>
                            <div class="stat-row">
                                <div class="stat-text-box card-box-style" th:classappend="${card.defence >= 90 ? ' card-box-rare' : ''}">
                                    <span>Defence: <strong th:text="${card.defence}"></strong></span>
                                </div>
                                <div class="stat-text-box card-box-style" th:classappend="${card.luck >= 90 ? ' card-box-rare' : ''}">
                                    <span>Luck: <strong th:text="${card.luck}"></strong></span>
                                </div>
                            </div>
                            <div class="unique-stat-box card-box-style text-nowrap" th:classappend="${card.customStat >= 90 ? ' card-box-rare' : ''}">
                            <span>
                                <span th:text="' ' + ${card.deck.uniqueStatName} + ': '"></span>
                                <strong th:text="${card.customStat}"></strong>
                            </span>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Non-clickable hand, for viewign-->
        <div th:unless="${roundComplete == false and playedCard == null}">
            <div class="card-row" style="display: flex; flex-wrap: wrap; gap: 16px;">
                <div th:each="card : ${playerHand}" class="p-3">
                    <div class="card-wrap" style="cursor: default;"
                         th:classappend="${card.deck.name == 'The Simpsons' ? ' simpson' :
                                     card.deck.name == 'Harry Potter' ? ' hp' :
                                     card.deck.name == 'Marvel' ? ' marvel' :
                                     card.deck.name == 'Disney' ? ' disney' :
                                     card.deck.name == 'Pop-culture' ? ' pop-culture' :
                                     card.deck.name == 'Brit-tv' ? ' brit-tv' :
                                     card.deck.name == 'Kids-tv' ? ' kids-tv' : ''}">
                        <strong class="card-name" th:text="${#strings.toUpperCase(card.name)}"></strong>
                        <div class="card-image-box">
                            <img th:src="${card.imageSource}" alt="Card image" width="220"/>
                        </div>
                        <div class="card-text-box card-box-style">
                            <span th:text="${card.flavourText}"></span>
                        </div>
                        <div class="stat-row">
                            <div class="stat-text-box card-box-style" th:classappend="${card.strength >= 90 ? ' card-box-rare' : ''}">
                                <span>Strength: <strong th:text="${card.strength}"></strong></span>
                            </div>
                            <div class="stat-text-box card-box-style" th:classappend="${card.wisdom >= 90 ? ' card-box-rare' : ''}">
                                <span>Wisdom: <strong th:text="${card.wisdom}"></strong></span>
                            </div>
                        </div>
                        <div class="stat-row">
                            <div class="stat-text-box card-box-style" th:classappend="${card.defence >= 90 ? ' card-box-rare' : ''}">
                                <span>Defence: <strong th:text="${card.defence}"></strong></span>
                            </div>
                            <div class="stat-text-box card-box-style" th:classappend="${card.luck >= 90 ? ' card-box-rare' : ''}">
                                <span>Luck: <strong th:text="${card.luck}"></strong></span>
                            </div>
                        </div>
                        <div class="unique-stat-box card-box-style text-nowrap" th:classappend="${card.customStat >= 90 ? ' card-box-rare' : ''}">
                        <span>
                            <span th:text="' ' + ${card.deck.uniqueStatName} + ': '"></span>
                            <strong th:text="${card.customStat}"></strong>
                        </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Play again button at end of game -->
    <div style="text-align: center; margin-top: 20px;">
        <a th:if="${#lists.size(playerHand) == 0}" th:href="@{/game/reset}" class="button">Play Again</a>
    </div>

    <!-- Finish Game button -->
    <div style="text-align: center; margin-top: 20px;">
        <a th:if="${gameOver}" th:href="@{/game/reset}" class="button">Finish</a>
    </div>

    <!--New game/reset hand button-->
    <a th:if="${!gameOver}" th:href="@{/game/reset}" type="submit" class="button">New Game</a>

    <div th:insert="~{fragments/footer :: footer}"></div>
    <div th:insert="~{fragments/tutorial :: tutorialModal}"></div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>